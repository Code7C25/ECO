<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ECO - Diario</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* estilos puntuales para calendario */
    .calendar-wrap { max-width:900px; margin:40px auto; background:rgba(255,255,255,0.9); padding:18px; border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
    .calendar-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .month-title { font-weight:600; color:#4B0082; }
    .grid { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; }
    .day { padding:12px; min-height:90px; border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.6)); border:1px solid rgba(0,0,0,0.04); cursor:pointer; position:relative; }
    .day .date-num { position:absolute; top:8px; left:10px; font-size:0.9rem; color:#666; }
    .entry-dot { width:10px; height:10px; border-radius:50%; position:absolute; right:8px; bottom:8px; }
    .mood-legend { display:flex; gap:10px; justify-content:center; margin-top:12px; }
    .mood-pill { padding:6px 10px; border-radius:16px; background:#f2f0f8; font-weight:600; color:#4B0082; }
    /* modal */
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.35); z-index:1000; }
    .modal-card { background:white; padding:18px; border-radius:12px; width:90%; max-width:420px; }
    .mood-btn { padding:10px 14px; margin-right:8px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
</head>
<body>
  <div class="menu-icon" style="display:none"></div>
  <button class="home-btn" onclick="location.href='menu.html'">ğŸ </button>

  <div style="max-width:1100px; margin:24px auto 0; padding:0 14px;">
    <h2 style="text-align:center; color:#4B0082;">Mi diario emocional</h2>
    <p style="text-align:center; color:#6b5a78;">GuardÃ¡ cÃ³mo te sentiste cada dÃ­a. Si estÃ¡s logueado se guarda en tu cuenta; si no, queda en el dispositivo.</p>

    <div class="calendar-wrap" id="calendarWrap">
      <div class="calendar-header">
        <div>
          <button id="prevMonth">â—€</button>
          <button id="nextMonth">â–¶</button>
        </div>
        <div class="month-title" id="monthTitle"></div>
        <div><button onclick="location.href='index.html'">Volver</button></div>
      </div>

      <div class="grid" id="weekdayNames">
        <div>Dom</div><div>Lun</div><div>Mar</div><div>MiÃ©</div><div>Jue</div><div>Vie</div><div>SÃ¡b</div>
      </div>

      <div class="grid" id="daysGrid"></div>

      <div class="mood-legend">
        <span class="mood-pill">ğŸ˜¢ Triste</span>
        <span class="mood-pill">ğŸ˜ Neutral</span>
        <span class="mood-pill">ğŸ™‚ Bien</span>
        <span class="mood-pill">ğŸ˜„ Muy Bien</span>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div id="modal" style="display:none;">
    <div class="modal">
      <div class="modal-card">
        <h3 id="modalDateTitle">Fecha</h3>
        <p>Â¿CÃ³mo te sentiste hoy?</p>
        <div style="margin-bottom:10px;">
          <button class="mood-btn" style="background:#7fb3d5;color:white" data-mood="Muy bien">ğŸ˜„ Muy Bien</button>
          <button class="mood-btn" style="background:#b2d8b2;color:#1b3d1b" data-mood="Bien">ğŸ™‚ Bien</button>
          <button class="mood-btn" style="background:#f2e08e;color:#6b5b00" data-mood="Neutral">ğŸ˜ Neutral</button>
          <button class="mood-btn" style="background:#f1a6a6;color:#5b1a1a" data-mood="Triste">ğŸ˜¢ Triste</button>
        </div>
        <textarea id="entryText" placeholder="EscribÃ­ una nota (opcional)" rows="4" style="width:100%;"></textarea>
        <div style="text-align:right; margin-top:10px;">
          <button id="saveEntry" style="padding:8px 14px; border-radius:8px;">Guardar</button>
          <button id="cancelEntry" style="padding:8px 14px; margin-left:8px;">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

<script>
  // calendario bÃ¡sico
  const daysGrid = document.getElementById('daysGrid');
  const monthTitle = document.getElementById('monthTitle');
  const prevBtn = document.getElementById('prevMonth');
  const nextBtn = document.getElementById('nextMonth');
  let current = new Date();

  // data storage helpers
  function getStorageKey() {
    const user = firebase.auth().currentUser;
    return user ? `diario_${user.uid}` : 'diario_local';
  }

  async function saveEntry(dateISO, mood, text) {
    const user = firebase.auth().currentUser;
    if (user) {
      // guardo en Firestore (colecciÃ³n diarios -> doc uid -> entradas -> doc fecha)
      await firebase.firestore().collection('diarios').doc(user.uid).collection('entradas').doc(dateISO).set({
        mood, text, guardado: new Date()
      });
    } else {
      // localStorage
      const key = getStorageKey();
      const store = JSON.parse(localStorage.getItem(key) || '{}');
      store[dateISO] = { mood, text, guardado: new Date().toISOString() };
      localStorage.setItem(key, JSON.stringify(store));
    }
  }

  async function loadEntry(dateISO) {
    const user = firebase.auth().currentUser;
    if (user) {
      const doc = await firebase.firestore().collection('diarios').doc(user.uid).collection('entradas').doc(dateISO).get();
      return doc.exists ? doc.data() : null;
    } else {
      const key = getStorageKey();
      const store = JSON.parse(localStorage.getItem(key) || '{}');
      return store[dateISO] || null;
    }
  }

  function renderCalendar(date) {
    daysGrid.innerHTML = '';
    const year = date.getFullYear();
    const month = date.getMonth();
    monthTitle.textContent = date.toLocaleString('es-AR', { month:'long', year:'numeric' });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month+1, 0).getDate();

    // blank days
    for (let i=0;i<firstDay;i++) {
      const blank = document.createElement('div');
      blank.className='day';
      blank.style.background='transparent';
      blank.style.border='none';
      blank.style.cursor='default';
      daysGrid.appendChild(blank);
    }

    for (let d=1; d<=daysInMonth; d++) {
      const day = document.createElement('div');
      day.className='day';
      day.innerHTML = `<div class="date-num">${d}</div>`;
      const dt = new Date(year, month, d);
      const iso = dt.toISOString().slice(0,10);

      // cargar entrada y si existe mostrar punto de color
      loadEntry(iso).then(entry => {
        if (entry && entry.mood) {
          const dot = document.createElement('div');
          dot.className='entry-dot';
          // map mood to color
          const color = entry.mood.includes('Muy') ? '#3EC300' :
                        entry.mood.includes('Bien') ? '#7bbf61' :
                        entry.mood.includes('Neutral') ? '#f2c94c' : '#f06262';
          dot.style.background = color;
          day.appendChild(dot);
        }
      });

      // click para modal
      day.addEventListener('click', () => openModal(iso, dt));
      daysGrid.appendChild(day);
    }
  }

  // modal logic
  const modal = document.getElementById('modal');
  const modalDateTitle = document.getElementById('modalDateTitle');
  const entryText = document.getElementById('entryText');
  let selectedDateISO = null;
  document.getElementById('cancelEntry').addEventListener('click', closeModal);
  document.getElementById('saveEntry').addEventListener('click', async () => {
    const moodBtn = document.querySelector('.mood-btn[aria-pressed="true"]');
    const mood = moodBtn ? moodBtn.dataset.mood : null;
    const text = entryText.value.trim();
    if (!mood) {
      alert('ElegÃ­ cÃ³mo te sentiste.');
      return;
    }
    await saveEntry(selectedDateISO, mood, text);
    closeModal();
    // re-render
    renderCalendar(current);
  });

  // mood button toggle
  document.querySelectorAll('.mood-btn').forEach(btn=>{
    btn.addEventListener('click', () => {
      document.querySelectorAll('.mood-btn').forEach(b=> b.removeAttribute('aria-pressed'));
      btn.setAttribute('aria-pressed','true');
    });
  });

  function openModal(iso, dt) {
    selectedDateISO = iso;
    modalDateTitle.textContent = dt.toLocaleDateString('es-AR', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
    entryText.value = '';
    document.querySelectorAll('.mood-btn').forEach(b=> b.removeAttribute('aria-pressed'));
    loadEntry(iso).then(e=>{
      if (e) {
        // preselect mood
        document.querySelectorAll('.mood-btn').forEach(b=>{
          if (b.dataset.mood === e.mood) b.setAttribute('aria-pressed','true');
        });
        entryText.value = e.text || '';
      }
    });
    modal.style.display = 'block';
  }

  function closeModal() { modal.style.display='none'; selectedDateISO=null; }

  // month navigation
  prevBtn.addEventListener('click', ()=> { current = new Date(current.getFullYear(), current.getMonth()-1,1); renderCalendar(current); });
  nextBtn.addEventListener('click', ()=> { current = new Date(current.getFullYear(), current.getMonth()+1,1); renderCalendar(current); });

  // initial
  renderCalendar(current);

  // si cambia auth (pasa de anÃ³nimo a logueado mientras se queda en la pÃ¡gina) re-render
  firebase.auth().onAuthStateChanged(()=> renderCalendar(current));
</script>
</body>
</html>

