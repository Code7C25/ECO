<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ECO - Diario</title>
  <link rel="stylesheet" href="style.css"/>

  <style>
    /* === Estilos generales del calendario === */
    .calendar-wrap {
      max-width: 900px;
      margin: 40px auto;
      background: rgba(255,255,255,0.9);
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.06);
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .month-nav {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .month-title {
      font-weight: 600;
      color: #4B0082;
      text-transform: capitalize;
      flex: 1;
      text-align: center;
    }

    /* === Navegaci√≥n de meses === */
    #prevMonth,
    #nextMonth {
      border: none;
      cursor: pointer;
      font-size: 1.6rem;
      line-height: 1;
      padding: 6px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #7d3c98;
      background: none;
      transition: background-color 0.2s ease;
    }

    #prevMonth:hover,
    #nextMonth:hover {
      background-color: rgba(125, 60, 152, 0.1);
      border-radius: 50%;
    }

    .volver-btn {
      background-color: #7d3c98;
      color: white;
      border: none;
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .volver-btn:hover {
      background-color: #6a2e91;
    }

    .volver-container {
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(7,1fr);
      gap: 8px;
    }

    .day {
      padding: 12px;
      min-height: 90px;
      border-radius: 10px;
      background: linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.6));
      border: 1px solid rgba(0,0,0,0.04);
      cursor: pointer;
      position: relative;
    }

    .day .date-num {
      position: absolute;
      top: 8px;
      left: 10px;
      font-size: 0.9rem;
      color: #666;
    }

    .entry-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      position: absolute;
      right: 8px;
      bottom: 8px;
    }

    /* === Modal === */
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
    }

    .modal-card {
      background: white;
      padding: 22px;
      border-radius: 14px;
      width: 90%;
      max-width: 420px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    /* Contenedor de emociones */
    .mood-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      width: 100%;
    }

    /* Botones de emoci√≥n */
    .mood-btn {
      width: 90%;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid transparent;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: transform 0.15s ease, border-color 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .mood-btn:hover {
      transform: scale(1.02);
    }

    /* Estado seleccionado */
    .mood-btn.selected {
      border: 2px solid #2ecc71;
      box-shadow: 0 0 6px rgba(46,204,113,0.6);
    }

    /* Icono del tilde verde */
    .mood-btn::after {
      content: "‚úî";
      position: absolute;
      right: 15px;
      font-size: 1.2rem;
      color: #2ecc71;
      display: none;
    }

    .mood-btn.selected::after {
      display: block;
    }

    /* === Botones Guardar / Cancelar === */
    #saveEntry,
    #cancelEntry {
      background-color: #b49dd8;
      color: white;
      border: none;
      border-radius: 12px;
      padding: 10px 20px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      width: 48%;
    }

    #saveEntry:hover {
      background-color: #a286d4;
    }

    #cancelEntry:hover {
      background-color: #9b7fcc;
    }

    .modal-card div[style*="text-align:right"] {
      display: flex;
      justify-content: space-between;
      margin-top: 16px;
      text-align: center;
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase.js"></script>
</head>

<body>
  <div style="max-width:1100px; margin:24px auto 0; padding:0 14px;">
    <h2 style="text-align:center; color:#4B0082;">Mi diario emocional</h2>
    <p style="text-align:center; color:#6b5a78;">Registr√° como te sent√≠s y animate al cambio. Estamos para vos!!

    <div class="calendar-wrap" id="calendarWrap">
      <div class="calendar-header">
        <div class="month-nav">
          <button id="prevMonth">‚óÄ</button>
          <button id="nextMonth">‚ñ∂</button>
        </div>
        <div class="month-title" id="monthTitle"></div>
        <div class="volver-container">
          <button class="volver-btn" onclick="location.href='menu.html'">Volver</button>
        </div>
      </div>

      <div class="grid" id="weekdayNames">
        <div>Dom</div><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div>
      </div>
      <div class="grid" id="daysGrid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" style="display:none;">
    <div class="modal">
      <div class="modal-card">
        <h3 id="modalDateTitle">Fecha</h3>
        <p>¬øC√≥mo te sentiste hoy?</p>

        <div class="mood-container">
          <button class="mood-btn" style="background:#7fb3d5;color:white" data-mood="Muy bien">üòÑ Muy Bien</button>
          <button class="mood-btn" style="background:#b2d8b2;color:#1b3d1b" data-mood="Bien">üôÇ Bien</button>
          <button class="mood-btn" style="background:#f2e08e;color:#6b5b00" data-mood="Neutral">üòê Neutral</button>
          <button class="mood-btn" style="background:#f1a6a6;color:#5b1a1a" data-mood="Triste">üò¢ Triste</button>
        </div>

        <textarea id="entryText" placeholder="Escrib√≠ una nota (opcional)" rows="4" style="width:100%;"></textarea>

        <div style="text-align:right; margin-top:10px;">
          <button id="saveEntry">Guardar</button>
          <button id="cancelEntry">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const daysGrid = document.getElementById('daysGrid');
    const monthTitle = document.getElementById('monthTitle');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');
    let current = new Date();

    function getStorageKey() {
      const user = firebase.auth().currentUser;
      return user ? `diario_${user.uid}` : 'diario_local';
    }

    async function saveEntry(dateISO, moods, text) {
      const user = firebase.auth().currentUser;
      const data = { moods, text, guardado: new Date() };
      if (user) {
        await firebase.firestore().collection('diarios').doc(user.uid).collection('entradas').doc(dateISO).set(data);
      } else {
        const key = getStorageKey();
        const store = JSON.parse(localStorage.getItem(key) || '{}');
        store[dateISO] = { ...data, guardado: new Date().toISOString() };
        localStorage.setItem(key, JSON.stringify(store));
      }
    }

    async function loadEntry(dateISO) {
      const user = firebase.auth().currentUser;
      if (user) {
        const doc = await firebase.firestore().collection('diarios').doc(user.uid).collection('entradas').doc(dateISO).get();
        return doc.exists ? doc.data() : null;
      } else {
        const key = getStorageKey();
        const store = JSON.parse(localStorage.getItem(key) || '{}');
        return store[dateISO] || null;
      }
    }

    function renderCalendar(date) {
      daysGrid.innerHTML = '';
      const year = date.getFullYear();
      const month = date.getMonth();
      monthTitle.textContent = date.toLocaleString('es-AR', { month:'long', year:'numeric' });

      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month+1, 0).getDate();

      for (let i=0;i<firstDay;i++) {
        const blank = document.createElement('div');
        blank.className='day';
        blank.style.background='transparent';
        blank.style.border='none';
        blank.style.cursor='default';
        daysGrid.appendChild(blank);
      }

      for (let d=1; d<=daysInMonth; d++) {
        const day = document.createElement('div');
        day.className='day';
        day.innerHTML = `<div class="date-num">${d}</div>`;
        const dt = new Date(year, month, d);
        const iso = dt.toISOString().slice(0,10);

        loadEntry(iso).then(entry => {
          if (entry && entry.moods && entry.moods.length) {
            const dot = document.createElement('div');
            dot.className='entry-dot';
            const mood = entry.moods[0];
            const color = mood.includes('Muy') ? '#3EC300' :
                          mood.includes('Bien') ? '#7bbf61' :
                          mood.includes('Neutral') ? '#f2c94c' : '#f06262';
            dot.style.background = color;
            day.appendChild(dot);
          }
        });

        day.addEventListener('click', () => openModal(iso, dt));
        daysGrid.appendChild(day);
      }
    }

    const modal = document.getElementById('modal');
    const modalDateTitle = document.getElementById('modalDateTitle');
    const entryText = document.getElementById('entryText');
    let selectedDateISO = null;

    const moodButtons = document.querySelectorAll('.mood-btn');
    let selectedMoods = [];

    moodButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const mood = btn.getAttribute('data-mood');
        if (btn.classList.contains('selected')) {
          btn.classList.remove('selected');
          selectedMoods = selectedMoods.filter(m => m !== mood);
        } else {
          if (selectedMoods.length < 2) {
            btn.classList.add('selected');
            selectedMoods.push(mood);
          } else {
            alert("Solo pod√©s seleccionar hasta dos opciones üòä");
          }
        }
      });
    });

    document.getElementById('cancelEntry').addEventListener('click', closeModal);
    document.getElementById('saveEntry').addEventListener('click', async () => {
      const text = entryText.value.trim();
      if (selectedMoods.length === 0) {
        alert('Eleg√≠ al menos una opci√≥n.');
        return;
      }
      await saveEntry(selectedDateISO, selectedMoods, text);
      closeModal();
      renderCalendar(current);
    });

    function openModal(iso, dt) {
      selectedDateISO = iso;
      modalDateTitle.textContent = dt.toLocaleDateString('es-AR', { weekday:'long', day:'numeric', month:'long', year:'numeric' });
      entryText.value = '';
      selectedMoods = [];
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));

      loadEntry(iso).then(e => {
        if (e) {
          entryText.value = e.text || '';
          if (e.moods) {
            e.moods.forEach(m => {
              document.querySelectorAll(`.mood-btn[data-mood='${m}']`).forEach(b => b.classList.add('selected'));
              selectedMoods.push(m);
            });
          }
        }
      });

      modal.style.display = 'block';
    }

    function closeModal() {
      modal.style.display='none';
      selectedDateISO=null;
      selectedMoods=[];
      document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('selected'));
    }

    prevBtn.addEventListener('click', ()=> { current = new Date(current.getFullYear(), current.getMonth()-1,1); renderCalendar(current); });
    nextBtn.addEventListener('click', ()=> { current = new Date(current.getFullYear(), current.getMonth()+1,1); renderCalendar(current); });

    renderCalendar(current);
    firebase.auth().onAuthStateChanged(()=> renderCalendar(current));
  </script>
</body>
</html>  